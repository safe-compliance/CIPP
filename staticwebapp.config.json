{
  "routes": [
    // 1) Assets e estáticos continuam cacheados
    {
      "route": "_next/static/*",
      "headers": {
        "cache-control": "must-revalidate, max-age=15770000"
      }
    },
    {
      "route": "*.{png,jpg,gif,xml,ico,css,js}",
      "headers": {
        "cache-control": "must-revalidate, max-age=15770000"
      }
    },
    {
      "route": "/assets/*",
      "headers": {
        "cache-control": "must-revalidate, max-age=15770000"
      }
    },

    // 2) Páginas públicas (front do CIPP) ficam anônimas
    {
      "route": "/",
      "rewrite": "/index.html",
      "allowedRoles": ["anonymous"]
    },
    {
      "route": "/index.html",
      "allowedRoles": ["anonymous"]
    },
    {
      "route": "/404",
      "rewrite": "/404",
      "allowedRoles": ["anonymous"]
    },

    // 3) Rota de login do AAD
    {
      "route": "/login",
      "rewrite": "/.auth/login/aad"
    },
    {
      "route": "/logout",
      "redirect": "/.auth/logout?post_logout_redirect_uri=/logout-succeeded",
      "statusCode": 302
    },

    // 4) Callback pós-logout público
    {
      "route": "/logout-succeeded",
      "allowedRoles": ["anonymous"]
    },

    // 5) API pública (se tiver)
    {
      "route": "/api/Public*",
      "allowedRoles": ["anonymous"]
    },

    // 6) Exige login apenas para a API protegida
    {
      "route": "/api/*",
      "allowedRoles": ["authenticated"]
    },

    // 7) Tudo o mais — se cair aqui, serve o front (SPA) mas sem exigir login
    {
      "route": "/*",
      "rewrite": "/index.html",
      "allowedRoles": ["anonymous"]
    }
  ],

  // fallback de SPA para rotas em branco
  "navigationFallback": {
    "rewrite": "/index.html",
    "exclude": [
      "_next/static/*",
      "/css/*",
      "public/*",
      "assets/*",
      "favicon.ico",
      "robots.txt",
      "sitemap.xml",
      "manifest.json"
    ]
  },

  // redirect automático para login ao obter 401
  "responseOverrides": {
    "401": {
      "redirect": "/.auth/login/aad?post_login_redirect_uri=.referrer",
      "statusCode": 302,
      "exclude": [
        "_next/static/*",
        "/assets/*",
        "/css/*"
      ]
    },
    "403": {
      "rewrite": "/404"
    }
  },

  // configuração de CSP e MIME como antes
  "globalHeaders": {
    "content-security-policy": "default-src https: blob: 'unsafe-eval' 'unsafe-inline'; object-src 'self' blob:; img-src 'self' blob: data: *"
  },
  "mimeTypes": {
    ".json": "text/json"
  },

  // configuração do AAD
  "auth": {
    "identityProviders": {
      "azureActiveDirectory": {
        "registration": {
          "openIdIssuer": "https://login.microsoftonline.com/ca23f150-3f58-49f6-b8d6-45b57e193208/v2.0",
          "clientId": "5e4a2a52-475b-4dd3-9436-e682b6acc603"
        }
      }
    }
  }
}
